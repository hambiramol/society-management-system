<!DOCTYPE html>
<html>
<head>
  <title>Admin - Society Members</title>
  <meta>
  <link rel="stylesheet" href="newstyle.css">
  <script src="index.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: auto;
      background: #f9f9f9;
      padding: 20px;
    }

    h2, h3 {
      color: #2c3e50;
    }

    input, button {
      margin: 5px;
      padding: 10px;
      font-size: 15px;
    }

    .tab-btns {
      margin-top: 20px;
    }

    .tab-btns button {
      padding: 10px 20px;
      border: none;
      background: #3498db;
      color: white;
      margin-right: 5px;
      cursor: pointer;
    }

    .tab-btns button.active {
      background: #2c3e50;
    }

    .tab-content {
      display: none;
      padding: 20px;
      margin-top: 10px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .tab-content.active {
      display: block;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
    }

    th {
      background: #f2f2f2;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
</head>
<body>

  <h2>ğŸ” Admin Panel</h2>
  <input id="adminPass" type="password" placeholder="Enter Admin Password">
  <button onclick="loginAdmin()">Login</button>

  <div id="adminSection" style="display:none;">
    
    <!-- Tab Buttons -->
    <div class="tab-btns">
      <button onclick="showTab('memberTab')" class="active">ğŸ‘¥ Member Management</button>
      <button onclick="showTab('duesTab')">ğŸ’³ Dues</button>
      <button onclick="showTab('expenseTab')">ğŸ’° Expenses</button>
      <button onclick="showTab('balanceTab')">ğŸ“Š Balance Sheet</button>
      <button onclick="showTab('backupTab')">ğŸ§° Backup & Utilities</button>
    </div>

    <!-- Member Management -->
    <div id="memberTab" class="tab-content active">
      <h3>Add New Member</h3>
      <input id="room" placeholder="Room Number">
      <input id="name" placeholder="Name">
      <input id="mobile" placeholder="Mobile Number">
      <input id="email" placeholder="Email ID">
      <input id="monthly" type="number" placeholder="Monthly Fee">
      <button onclick="addMember()">â• Add Member</button>

      <div class="member-list">
        <h3>ğŸ“‹ Member List</h3>
        <table>
          <thead>
            <tr>
              <th>Room</th>
              <th>Name</th>
              <th>Mobile</th>
              <th>Email</th>
              <th>Monthly Fee</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="memberTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Dues -->
    <div id="duesTab" class="tab-content">
      <h3>ğŸ§¾ Manually Generate Due Sheet</h3>
      <button onclick="generateDueSheet()">ğŸ“… Generate Dues Now</button>

      <h3>ğŸ“¤ Export Due Sheet</h3>
      <button onclick="exportDueAsExcel()">Export as Excel</button>
      <button onclick="exportDueAsPDF()">Export as PDF</button>

      <h3>ğŸ“† Generate Dues for Specific Month</h3>
      <input type="month" id="customMonth">
      <button onclick="generateDueForMonth()">Generate</button>

      <h3>ğŸ“‹ Show Dues for Specific Month</h3>
      <input type="month" id="viewMonth">
      <button onclick="showMonthlyDues()">View Dues</button>
      <div id="monthlyDuesList" style="margin-top: 10px;"></div>


      <h3>ğŸ“„ Generate Dues PDF for Specific Month</h3>
      <input type="month" id="pdfMonth">
      <button onclick="generateDuePDFforMonth()">ğŸ“¥ Generate PDF</button>

      <h3>ğŸ“© Notify Members</h3>
      <button onclick="notifyMembers()">Send SMS/Email (Simulated)</button>
    </div>

    <!-- Expenses -->
    <div id="expenseTab" class="tab-content">
      <h3>ğŸ“’ Record Society Expense</h3>
      <form onsubmit="recordExpense(event)">
        <input type="text" id="expDesc" placeholder="Expense Description" required><br>
        <input type="number" id="expAmount" placeholder="Amount (â‚¹)" required><br>
        <input type="text" id="expPaidTo" placeholder="Paid To" required><br>
        <input type="date" id="expDate" required><br>
        <button type="submit">Add Expense</button>
      </form>

      <h3>ğŸ’° Expense History</h3>
      <ul id="expenseList"></ul>
    </div>

    <!-- Balance Sheet -->
    <div id="balanceTab" class="tab-content">
      <h3>ğŸ“† Monthly Balance Sheet</h3>
      <label for="monthSelect">Select Month:</label>
      <input type="month" id="monthSelect" onchange="generateBalanceSheet()">
      <div id="balanceSheetResult" style="margin-top: 20px;"></div>
    </div>

    <!-- Backup -->
    <div id="backupTab" class="tab-content">
      <h3>ğŸ“¦ Backup All Data</h3>
      <button onclick="exportMemberData()">Download Backup (JSON)</button>
    </div>
  </div>

  

  <!-- <script>

let members = JSON.parse(localStorage.getItem("members") || "[]");
let expenses = JSON.parse(localStorage.getItem("expenses") || "[]");

function save() {
  localStorage.setItem("members", JSON.stringify(members));
  renderMembers();
}

function loginAdmin() {
  const pass = document.getElementById("adminPass").value;
  if (pass === "admin123") {
    document.getElementById("adminSection").style.display = "block";
    updateMonthlyDue();
    renderMembers();
    renderExpenses();
  } else {
    alert("Invalid password");
  }
}

function addMember() {
  const room = document.getElementById("room").value.trim();
  const name = document.getElementById("name").value.trim();
  const mobile = document.getElementById("mobile").value.trim();
  const email = document.getElementById("email").value.trim();
  const monthly = parseFloat(document.getElementById("monthly").value);

  if (!room || !name || !mobile || !email || isNaN(monthly)) {
    return alert("Please fill in all fields correctly.");
  }

  if (members.find(m => m.room === room)) {
    return alert("Room number already exists.");
  }

  members.push({
    room, name, mobile, email, monthly,
    balance: 0,
    payments: []
  });

  clearForm();
  save();
  alert("Member added successfully.");
}

function clearForm() {
  document.getElementById("room").value = "";
  document.getElementById("name").value = "";
  document.getElementById("mobile").value = "";
  document.getElementById("email").value = "";
  document.getElementById("monthly").value = "";
}

function renderMembers() {
  const table = document.getElementById("memberTable");
  table.innerHTML = "";

  members.forEach((m, index) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${m.room}</td>
      <td>${m.name}</td>
      <td>${m.mobile}</td>
      <td>${m.email}</td>
      <td>â‚¹${m.monthly}</td>
      <td>
        <button onclick="deleteMember(${index})">ğŸ—‘ï¸ Delete</button>
      </td>
    `;
    table.appendChild(row);
  });
}

function deleteMember(index) {
  if (confirm("Are you sure you want to delete this member?")) {
    members.splice(index, 1);
    save();
  }
}

function updateMonthlyDue() {
  const currentMonth = new Date().toISOString().slice(0, 7);
  const lastUpdatedMonth = localStorage.getItem("lastDueUpdate");

  if (currentMonth !== lastUpdatedMonth) {
    members.forEach(member => {
      member.balance += member.monthly;
    });
    localStorage.setItem("lastDueUpdate", currentMonth);
    save();
    alert("Monthly dues updated for all members.");
  }
}

function generateDueSheet() {
  if (!confirm("Generate dues for all members?")) return;
  members.forEach(member => {
    member.balance += member.monthly;
  });
  save();
  alert("Due sheet generated.");
}

function exportDueAsExcel() {
  let csv = "Room,Name,Mobile,Email,Monthly Fee,Balance Due\n";
  members.forEach(m => {
    csv += `${m.room},${m.name},${m.mobile},${m.email},${m.monthly},${m.balance}\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `DueSheet_${new Date().toISOString().slice(0, 10)}.csv`;
  a.click();
}

async function exportDueAsPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.text("Society Due Sheet", 80, 15);
  doc.setFontSize(10);
  let y = 30;

  doc.text("Room", 10, y);
  doc.text("Name", 30, y);
  doc.text("Mobile", 70, y);
  doc.text("Monthly", 120, y);
  doc.text("Balance", 150, y);
  y += 10;

  members.forEach((m) => {
    doc.text(m.room, 10, y);
    doc.text(m.name, 30, y);
    doc.text(m.mobile, 70, y);
    doc.text(String(m.monthly), 120, y);
    doc.text(String(m.balance), 150, y);
    y += 10;
    if (y > 280) {
      doc.addPage();
      y = 20;
    }
  });

  doc.save(`DueSheet_${new Date().toISOString().slice(0, 10)}.pdf`);
}

function renderExpenses() {
  const list = document.getElementById("expenseList");
  list.innerHTML = expenses.map(e =>
    `<li><strong>${e.date}</strong>: â‚¹${e.amount} â€“ ${e.description} (Paid to: ${e.paidTo})</li>`
  ).join('') || "<li>No expenses recorded yet</li>";
}

function recordExpense(e) {
  e.preventDefault();

  const newExp = {
    description: document.getElementById("expDesc").value,
    amount: parseFloat(document.getElementById("expAmount").value),
    paidTo: document.getElementById("expPaidTo").value,
    date: document.getElementById("expDate").value
  };

  expenses.push(newExp);
  localStorage.setItem("expenses", JSON.stringify(expenses));
  alert("Expense recorded successfully!");
  e.target.reset();
  renderExpenses();
}

function exportMemberData() {
  const blob = new Blob([JSON.stringify(members, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `SocietyData_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
}

function showTab(id) {
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-btns button').forEach(btn => btn.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  const buttons = document.querySelectorAll('.tab-btns button');
  const tabIndex = ['memberTab', 'duesTab', 'expenseTab', 'balanceTab', 'backupTab'].indexOf(id);
  if (buttons[tabIndex]) buttons[tabIndex].classList.add('active');
}

function generateBalanceSheet() {
  const selectedMonth = document.getElementById("monthSelect").value; // Format: YYYY-MM
  if (!selectedMonth) return;

  const members = JSON.parse(localStorage.getItem("members") || "[]");
  const expenses = JSON.parse(localStorage.getItem("expenses") || "[]");

  let openingBalance = 0;
  let totalIncome = 0;
  let totalExpenses = 0;
  let paymentsThisMonth = [];
  let expensesThisMonth = [];

  const [selYear, selMonth] = selectedMonth.split('-').map(Number);

  members.forEach(member => {
    (member.payments || []).forEach(p => {
      const [year, month] = parseDateParts(p.date);
      if (year < selYear || (year === selYear && month < selMonth)) {
        openingBalance += parseFloat(p.amount);
      } else if (year === selYear && month === selMonth) {
        totalIncome += parseFloat(p.amount);
        paymentsThisMonth.push({
          room: member.room,
          name: member.name,
          amount: p.amount,
          date: p.date
        });
      }
    });
  });

  expenses.forEach(exp => {
    const [year, month] = parseDateParts(exp.date);
    if (year < selYear || (year === selYear && month < selMonth)) {
      openingBalance -= parseFloat(exp.amount);
    } else if (year === selYear && month === selMonth) {
      totalExpenses += parseFloat(exp.amount);
      expensesThisMonth.push(exp);
    }
  });

  const closingBalance = openingBalance + totalIncome - totalExpenses;

  let html = `
    <div class="card">
      <strong>Month:</strong> ${selectedMonth}<br>
      <strong>Opening Balance:</strong> â‚¹${openingBalance.toFixed(2)}<br>
      <strong>Total Income (this month):</strong> â‚¹${totalIncome.toFixed(2)}<br>
      <strong>Total Expenses (this month):</strong> â‚¹${totalExpenses.toFixed(2)}<br>
      <strong>Closing Balance:</strong> â‚¹${closingBalance.toFixed(2)} 
      (${closingBalance >= 0 ? "<span style='color:green'>Surplus</span>" : "<span style='color:red'>Deficit</span>"})
    </div>
  `;

  // Show payment breakdown
  html += `<h4>ğŸ’° Payments Received</h4><ul>`;
  if (paymentsThisMonth.length === 0) {
    html += `<li>No payments recorded for this month.</li>`;
  } else {
    paymentsThisMonth.forEach(p => {
      html += `<li>${p.room} (${p.name}) paid â‚¹${p.amount} on ${p.date}</li>`;
    });
  }
  html += `</ul>`;

  // Show expense breakdown
  html += `<h4>ğŸ§¾ Expenses Made</h4><ul>`;
  if (expensesThisMonth.length === 0) {
    html += `<li>No expenses recorded for this month.</li>`;
  } else {
    expensesThisMonth.forEach(e => {
      html += `<li>â‚¹${e.amount} paid to ${e.paidTo} on ${e.date} (${e.description})</li>`;
    });
  }
  html += `</ul>`;

  document.getElementById("balanceSheetResult").innerHTML = html;
}

// Helper function
function parseDateParts(dateStr) {
  const d = new Date(dateStr);
  return [d.getFullYear(), d.getMonth() + 1]; // month: 0-indexed
}

function generateDueForMonth() {
    const selectedMonth = document.getElementById("customMonth").value;
    if (!selectedMonth) return alert("Select a month.");

    const key = `dueGenerated_${selectedMonth}`;
    if (localStorage.getItem(key)) {
        if (!confirm("Dues already generated for this month. Generate again?")) return;
    }

    members.forEach(member => {
        member.balance += member.monthly;
    });

    localStorage.setItem("members", JSON.stringify(members));
    localStorage.setItem(key, "true");
    alert(`Dues generated for ${selectedMonth}`);
    renderMembers();
    }

    function notifyMembers() {
    members.forEach(member => {
        console.log(`SMS to ${member.mobile}: Your current balance is â‚¹${member.balance}`);
        console.log(`Email to ${member.email}: Dear ${member.name}, your due is â‚¹${member.balance}`);
    });

    alert("Simulated SMS and Email notifications sent to console.");
    }

    async function generateDuePDFforMonth() {
    const monthInput = document.getElementById("pdfMonth").value;
    if (!monthInput) return alert("Please select a month.");

    const [year, month] = monthInput.split("-");
    const monthName = new Date(`${monthInput}-01`).toLocaleString("default", { month: "long" });

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(16);
    doc.text(`Due Sheet - ${monthName} ${year}`, 70, 15);

    doc.setFontSize(10);
    let y = 30;

    doc.text("Room", 10, y);
    doc.text("Name", 30, y);
    doc.text("Mobile", 70, y);
    doc.text("Email", 100, y);
    doc.text("Monthly", 150, y);
    doc.text("Balance", 180, y);
    y += 10;

    members.forEach(member => {
      doc.text(member.room, 10, y);
      doc.text(member.name, 30, y);
      doc.text(member.mobile, 70, y);
      doc.text(member.email, 100, y);
      doc.text(`â‚¹${member.monthly}`, 150, y);
      doc.text(`â‚¹${member.balance}`, 180, y);
      y += 10;

      if (y > 280) {
        doc.addPage();
        y = 20;
      }
    });

    doc.save(`DueSheet_${monthName}_${year}.pdf`);
  }

</script> -->

</body>
</html>
